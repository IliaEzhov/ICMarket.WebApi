# CI/CD Pipeline for ICMarket.WebApi
# Triggers on push to main/development branches and pull requests
# Jobs: Build → Test → Docker Build → (Optional) Docker Push

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - development
  pull_request:
    branches:
      - main
      - master
      - development
  workflow_dispatch: # Allow manual triggering

env:
  DOTNET_VERSION: '8.0.x'
  DOCKER_IMAGE_NAME: icmarket-api

jobs:
  # =============================================================================
  # BUILD JOB
  # =============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ICMarket.sln

      - name: Build solution
        run: dotnet build ICMarket.sln --configuration Release --no-restore

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            src/*/bin/Release/net8.0/
            tests/*/bin/Release/net8.0/
          retention-days: 1

  # =============================================================================
  # TEST JOB
  # =============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ICMarket.sln

      # Run all test projects in parallel with coverage
      - name: Run Unit Tests
        run: dotnet test tests/ICMarket.UnitTests/ICMarket.UnitTests.csproj --configuration Release --no-restore --verbosity normal --logger "trx;LogFileName=unit-tests.trx" --collect:"XPlat Code Coverage"

      - name: Run Integration Tests
        run: dotnet test tests/ICMarket.IntegrationTests/ICMarket.IntegrationTests.csproj --configuration Release --no-restore --verbosity normal --logger "trx;LogFileName=integration-tests.trx" --collect:"XPlat Code Coverage"

      - name: Run Functional Tests
        run: dotnet test tests/ICMarket.FunctionalTests/ICMarket.FunctionalTests.csproj --configuration Release --no-restore --verbosity normal --logger "trx;LogFileName=functional-tests.trx" --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            tests/**/TestResults/*.trx
            tests/**/TestResults/**/coverage.cobertura.xml
          retention-days: 7

  # =============================================================================
  # DOCKER BUILD JOB
  # =============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: src/API/Dockerfile
          push: false
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Test Docker container health
        run: |
          # Start container in background
          docker run -d --name icmarket-test -p 8080:8080 -e ASPNETCORE_HTTP_PORTS=8080 ${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # Wait for container to be ready (max 30 seconds)
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health | grep -q "Healthy"; then
              echo "Container is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Container health check failed"
              docker logs icmarket-test
              exit 1
            fi
            sleep 1
          done
          
          # Verify Swagger is accessible
          curl -s http://localhost:8080/swagger/v1/swagger.json | head -c 200
          
          # Cleanup
          docker stop icmarket-test
          docker rm icmarket-test

      - name: Save Docker image as artifact
        run: docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip > icmarket-api-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: icmarket-api-image.tar.gz
          retention-days: 7

  # =============================================================================
  # DOCKER PUSH JOB (Optional - only on main branch)
  # =============================================================================
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Uncomment and configure the following steps to push to a container registry
      # 
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #
      # - name: Login to GitHub Container Registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      #
      # - name: Build and push
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: src/API/Dockerfile
      #     push: true
      #     tags: |
      #       ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:latest
      #       ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

      - name: Docker Push placeholder
        run: |
          echo "Docker push is configured but commented out."
          echo "To enable, uncomment the login and push steps above and add secrets:"
          echo "  - DOCKERHUB_USERNAME and DOCKERHUB_TOKEN for Docker Hub"
          echo "  - GITHUB_TOKEN is automatically available for GitHub Container Registry"

  # =============================================================================
  # STATUS CHECK JOB (Summary)
  # =============================================================================
  status-check:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [build, test, docker-build]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "Build: ${{ needs.build.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          
          if [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "One or more jobs failed!"
            exit 1
          fi
          
          echo "All jobs completed successfully!"
